version: 0.2

env:
  variables:
    CLUSTER_NAME: "brain-tasks-eks"
    AWS_REGION: "us-east-1"
    K8S_DIR: "k8s"

phases:
  pre_build:
    commands:
      - echo "==== Updating kubeconfig ===="
      - aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION

      - echo "==== Verifying Kubernetes access ===="
      - kubectl get nodes

  build:
    commands:
      - echo "==== Applying Kubernetes Deployment ===="
      - kubectl apply -f $k8s/deployment.yaml

      - echo "==== Applying Kubernetes Service ===="
      - kubectl apply -f $k8s/service.yaml

  post_build:
    commands:
      - echo "==== Checking rollout status ===="
      - kubectl rollout status deployment/brain-tasks-app --timeout=120s || true

      - echo "==== Fetching service endpoints ===="
      - kubectl get svc

artifacts:
  files:
    - "**/*"
